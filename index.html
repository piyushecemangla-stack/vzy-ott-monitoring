<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VZY OTT Platform Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1563.0.min.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Modal for Service Details with Embedded Logs -->
    <div id="serviceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="app" class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <div class="text-center py-12">
                <div class="inline-block w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-gray-600 text-lg">Connecting to CloudWatch...</p>
                <p class="text-gray-400 text-sm mt-2" id="status">Initializing...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('Dashboard starting...');
        
        AWS.config.update({
            accessKeyId: 'AKIAWT5V2FQ6MKAHDFZB',
            secretAccessKey: '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',
            region: 'ap-south-1'
        });

        const cloudwatch = new AWS.CloudWatch();
        const cloudwatchLogs = new AWS.CloudWatchLogs();
        
        const THRESHOLDS = {
            latency: { warning: 500, critical: 1000 },
            errorRate: { warning: 5, critical: 10 },
            requestLimit: { max: 1000, warning: 800 }
        };

        // Service configuration with log groups
        const SERVICES = {
            'dish-login-generate-otp': {
                name: 'Generate OTP',
                category: 'Dish Backend',
                logGroup: '/aws/lambda/sso-be-proddish-generate-otp'
            },
            'dish-login-validate-otp': {
                name: 'Validate OTP',
                category: 'Dish Backend',
                logGroup: '/aws/lambda/sso-be-proddish-validateOtp'
            },
            'dish-getuserinfo': {
                name: 'Get User Info',
                category: 'Dish Backend',
                logGroup: '/aws/lambda/sso-be-proddish-getUserInfo'
            },
            'partner-zee5': {
                name: 'Zee5',
                category: 'Content Partners',
                logGroup: '/aws/lambda/sso-be-proddish-zee5'
            },
            'partner-sunnxt': {
                name: 'Sun Nxt',
                category: 'Content Partners',
                logGroup: '/aws/lambda/sso-be-proddish-sunNext'
            },
            'partner-sonyliv': {
                name: 'Sony Liv',
                category: 'Content Partners',
                logGroup: '/aws/lambda/sso-be-proddish-sonyLiv'
            },
            'partner-jiohotstar': {
                name: 'Jio Hotstar',
                category: 'Content Partners',
                logGroup: '/aws/lambda/sso-be-proddish-jiohotstar'
            }
        };
        
        function updateStatus(msg) {
            const el = document.getElementById('status');
            if (el) el.textContent = msg;
            console.log(msg);
        }

        async function fetchMetrics() {
            updateStatus('Fetching metrics...');
            const endTime = new Date();
            const startTime = new Date(endTime.getTime() - 30 * 60 * 1000);
            const results = {};
            
            for (const [serviceId, config] of Object.entries(SERVICES)) {
                try {
                    const dimensions = [
                        { Name: 'ServiceName', Value: serviceId },
                        { Name: 'Category', Value: config.category }
                    ];
                    
                    const [healthData, latencyData, errorData, invocationData] = await Promise.all([
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'ServiceHealth',
                            Dimensions: dimensions,
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Average']
                        }).promise(),
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'ServiceLatency',
                            Dimensions: dimensions,
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Average', 'Maximum']
                        }).promise(),
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'ErrorCount',
                            Dimensions: dimensions,
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Sum']
                        }).promise(),
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'Invocations',
                            Dimensions: dimensions,
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Sum']
                        }).promise()
                    ]);
                    
                    const healthValue = healthData.Datapoints.length > 0 ? healthData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0].Average : null;
                    const latencyPoint = latencyData.Datapoints.length > 0 ? latencyData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0] : null;
                    const errorValue = errorData.Datapoints.length > 0 ? errorData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0].Sum : 0;
                    const invocationValue = invocationData.Datapoints.length > 0 ? invocationData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0].Sum : 0;
                    
                    const avgLatency = latencyPoint ? Math.round(latencyPoint.Average) : 0;
                    const maxLatency = latencyPoint ? Math.round(latencyPoint.Maximum) : 0;
                    const errorRate = invocationValue > 0 ? (errorValue / invocationValue * 100) : 0;
                    
                    let status = 'unknown';
                    if (healthValue !== null) {
                        status = healthValue === 1 ? 'healthy' : healthValue >= 0.5 ? 'warning' : 'down';
                    }
                    
                    results[serviceId] = {
                        name: config.name,
                        category: config.category,
                        logGroup: config.logGroup,
                        status, health: healthValue,
                        avgLatency, maxLatency, errors: errorValue,
                        invocations: invocationValue, errorRate: errorRate.toFixed(2),
                        hasData: healthValue !== null
                    };
                    
                } catch (error) {
                    results[serviceId] = {
                        name: config.name,
                        category: config.category,
                        logGroup: config.logGroup,
                        status: 'unknown', avgLatency: 0, maxLatency: 0,
                        errors: 0, invocations: 0, errorRate: 0, hasData: false
                    };
                }
            }
            return results;
        }

        async function fetchLogs(logGroup, limit = 20) {
            try {
                const streams = await cloudwatchLogs.describeLogStreams({
                    logGroupName: logGroup,
                    orderBy: 'LastEventTime',
                    descending: true,
                    limit: 3
                }).promise();

                if (!streams.logStreams || streams.logStreams.length === 0) {
                    return '<div class="text-gray-500 italic p-4">No recent log streams found</div>';
                }

                let allLogs = [];
                for (const stream of streams.logStreams.slice(0, 2)) {
                    try {
                        const events = await cloudwatchLogs.getLogEvents({
                            logGroupName: logGroup,
                            logStreamName: stream.logStreamName,
                            limit: limit,
                            startFromHead: false
                        }).promise();

                        allLogs = allLogs.concat(events.events || []);
                    } catch (e) {
                        console.error('Error fetching log events:', e);
                    }
                }

                allLogs.sort((a, b) => b.timestamp - a.timestamp);
                allLogs = allLogs.slice(0, limit);

                if (allLogs.length === 0) {
                    return '<div class="text-gray-500 italic p-4">No recent log events</div>';
                }

                let html = '<div class="space-y-1">';
                allLogs.forEach(event => {
                    const time = new Date(event.timestamp).toLocaleTimeString();
                    const msg = event.message.trim();
                    const isError = msg.includes('ERROR') || msg.includes('Error');
                    const isReport = msg.includes('REPORT');
                    const isStart = msg.includes('START');
                    
                    let color = 'text-gray-700';
                    if (isError) color = 'text-red-600';
                    else if (isReport) color = 'text-blue-600';
                    else if (isStart) color = 'text-green-600';

                    html += `<div class="font-mono text-xs ${color} bg-gray-50 p-2 rounded border-l-2 ${isError ? 'border-red-500' : 'border-gray-300'}">
                        <span class="text-gray-500">${time}</span> ${msg.substring(0, 200)}${msg.length > 200 ? '...' : ''}
                    </div>`;
                });
                html += '</div>';
                return html;
            } catch (error) {
                console.error('Error fetching logs:', error);
                return `<div class="text-red-500 p-4">Error loading logs: ${error.message}</div>`;
            }
        }

        async function showDetails(serviceId) {
            const service = window.allServices[serviceId];
            if (!service) return;

            const color = service.status === 'healthy' ? 'green' : service.status === 'warning' ? 'orange' : 'gray';
            const icon = service.status === 'healthy' ? 'âœ“' : service.status === 'warning' ? 'âš ' : '?';
            
            document.getElementById('modalContent').innerHTML = `
                <div class="p-8">
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">${service.name}</h2>
                            <p class="text-gray-600">${service.category}</p>
                        </div>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl">Ã—</button>
                    </div>
                    
                    <!-- Metrics -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Requests</div>
                            <div class="text-3xl font-bold text-blue-600">${service.invocations}</div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Avg Latency</div>
                            <div class="text-3xl font-bold text-purple-600">${service.avgLatency}ms</div>
                        </div>
                        <div class="bg-${service.errors > 0 ? 'red' : 'green'}-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Errors</div>
                            <div class="text-3xl font-bold text-${service.errors > 0 ? 'red' : 'green'}-600">${service.errors}</div>
                        </div>
                        <div class="bg-${color}-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Health</div>
                            <div class="text-3xl font-bold text-${color}-600">${icon}</div>
                        </div>
                    </div>

                    <!-- CloudWatch Logs Section -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-900">ðŸ“‹ CloudWatch Logs</h3>
                            <button onclick="refreshLogs('${serviceId}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                ðŸ”„ Refresh Logs
                            </button>
                        </div>
                        <div id="logs-container" class="bg-white rounded-lg p-4 max-h-96 overflow-y-auto border border-gray-200">
                            <div class="flex items-center justify-center p-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                <span class="ml-3 text-gray-600">Loading logs...</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            Log Group: ${service.logGroup}
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="bg-blue-50 rounded-xl p-6 mb-6">
                        <h4 class="font-bold text-blue-900 mb-3">Service Details</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm text-blue-800">
                            <div><strong>Max Latency:</strong> ${service.maxLatency}ms</div>
                            <div><strong>Error Rate:</strong> ${service.errorRate}%</div>
                            <div><strong>Health Score:</strong> ${service.health !== null ? service.health.toFixed(1) : 'N/A'}</div>
                            <div><strong>Status:</strong> ${service.status.toUpperCase()}</div>
                        </div>
                    </div>

                    <button onclick="closeModal()" class="w-full px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                </div>
            `;
            
            document.getElementById('serviceModal').classList.remove('hidden');
            
            // Load logs after modal is shown
            const logsHtml = await fetchLogs(service.logGroup, 20);
            document.getElementById('logs-container').innerHTML = logsHtml;
        }

        async function refreshLogs(serviceId) {
            const service = window.allServices[serviceId];
            const container = document.getElementById('logs-container');
            container.innerHTML = '<div class="flex items-center justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><span class="ml-3 text-gray-600">Refreshing logs...</span></div>';
            const logsHtml = await fetchLogs(service.logGroup, 20);
            container.innerHTML = logsHtml;
        }

        function closeModal() {
            document.getElementById('serviceModal').classList.add('hidden');
        }

        document.getElementById('serviceModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function render(services) {
            window.allServices = services;
            const hasData = Object.values(services).some(s => s.hasData);
            
            // Group services by category
            const dishBackend = Object.entries(services).filter(([id, s]) => s.category === 'Dish Backend');
            const contentPartners = Object.entries(services).filter(([id, s]) => s.category === 'Content Partners');
            
            const totalServices = Object.keys(services).length;
            const healthyCount = Object.values(services).filter(s => s.status === 'healthy').length;
            const warningCount = Object.values(services).filter(s => s.status === 'warning').length;
            const downCount = Object.values(services).filter(s => s.status === 'down').length;
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h1 class="text-3xl font-bold">ðŸ“º VZY OTT Platform Monitor</h1>
                                <p class="text-gray-500 mt-1">Real-time system health â€¢ Region: ap-south-1</p>
                                ${hasData ? '<p class="text-green-600 text-sm mt-2 font-semibold">âœ“ Connected to AWS CloudWatch - REAL data</p>' : '<p class="text-yellow-600 text-sm mt-2">âš  No metrics</p>'}
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500 mb-2">Last updated: ${new Date().toLocaleTimeString()}</div>
                                <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ðŸ”„ Refresh</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4"><div class="text-2xl font-bold">${totalServices}</div><div class="text-sm text-gray-600">Total Services</div></div>
                            <div class="bg-green-50 rounded-lg p-4"><div class="text-2xl font-bold text-green-600">${healthyCount}</div><div class="text-sm text-gray-600">Healthy</div></div>
                            <div class="bg-orange-50 rounded-lg p-4"><div class="text-2xl font-bold text-orange-600">${warningCount}</div><div class="text-sm text-gray-600">Warning</div></div>
                            <div class="bg-red-50 rounded-lg p-4"><div class="text-2xl font-bold text-red-600">${downCount}</div><div class="text-sm text-gray-600">Down</div></div>
                        </div>
                    </div>

                    <!-- Dish Backend -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Dish Backend (${dishBackend.length} services)</h2>
                        <div class="grid grid-cols-3 gap-4">
                            ${dishBackend.map(([id, s]) => renderServiceCard(id, s)).join('')}
                        </div>
                    </div>

                    <!-- Content Partners -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Content Partners (${contentPartners.length} services)</h2>
                        <div class="grid grid-cols-4 gap-4">
                            ${contentPartners.map(([id, s]) => renderServiceCard(id, s)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderServiceCard(id, s) {
            const color = s.status === 'healthy' ? 'green' : s.status === 'warning' ? 'orange' : 'gray';
            const icon = s.status === 'healthy' ? 'âœ“' : s.status === 'warning' ? 'âš ' : '?';
            
            return `
                <div onclick="showDetails('${id}')" class="bg-${color}-50 border-2 border-${color}-200 rounded-xl p-4 hover:shadow-lg transition cursor-pointer">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-gray-800">${s.name}</h3>
                        <span class="text-${color}-600 text-2xl">${icon}</span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-700">
                        <div class="flex justify-between">
                            <span>Latency:</span>
                            <span class="font-mono font-bold">${s.avgLatency}ms</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Requests:</span>
                            <span class="font-mono font-bold">${s.invocations}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Errors:</span>
                            <span class="font-mono font-bold text-${s.errors > 0 ? 'red' : 'green'}-600">${s.errors}</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-${color}-200 text-${color}-700 text-xs font-semibold text-center">
                        Click to view logs â†’
                    </div>
                </div>
            `;
        }

        async function init() {
            try {
                updateStatus('Testing connection...');
                await cloudwatch.listMetrics({ Namespace: 'VZY/OTT' }).promise();
                console.log('âœ“ Connected');
                const services = await fetchMetrics();
                render(services);
                console.log('âœ“ Loaded');
            } catch (error) {
                console.error(error);
                document.getElementById('app').innerHTML = `<div class="max-w-2xl mx-auto mt-12 bg-red-50 border rounded-xl p-8"><h2 class="text-2xl font-bold text-red-900 mb-4">âš  Error</h2><p class="text-red-800 mb-4">${error.message}</p><button onclick="location.reload()" class="px-6 py-3 bg-red-600 text-white rounded-lg">Retry</button></div>`;
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>

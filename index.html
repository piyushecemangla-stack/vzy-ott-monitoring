<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VZY OTT Platform Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1563.0.min.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Modal for Service Details -->
    <div id="serviceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="app" class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <div class="text-center py-12">
                <div class="inline-block w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-gray-600 text-lg">Connecting to CloudWatch...</p>
                <p class="text-gray-400 text-sm mt-2" id="status">Initializing...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('Dashboard starting...');
        
        AWS.config.update({
            accessKeyId: 'AKIAWT5V2FQ6MKAHDFZB',
            secretAccessKey: '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',
            region: 'ap-south-1'
        });

        const cloudwatch = new AWS.CloudWatch();
        
        const THRESHOLDS = {
            latency: { warning: 500, critical: 1000 },
            errorRate: { warning: 5, critical: 10 },
            requestLimit: { max: 1000, warning: 800 }
        };
        
        function updateStatus(msg) {
            const el = document.getElementById('status');
            if (el) el.textContent = msg;
            console.log(msg);
        }

        async function fetchMetrics() {
            updateStatus('Fetching metrics...');
            const services = {
                'dish-login-generate-otp': { name: 'Generate OTP' },
                'dish-login-validate-otp': { name: 'Validate OTP' }
            };
            
            const endTime = new Date();
            const startTime = new Date(endTime.getTime() - 30 * 60 * 1000);
            const results = {};
            
            for (const [serviceId, config] of Object.entries(services)) {
                try {
                    const [healthData, latencyData, errorData, invocationData] = await Promise.all([
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'ServiceHealth',
                            Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Average']
                        }).promise(),
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'ServiceLatency',
                            Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Average', 'Maximum']
                        }).promise(),
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'ErrorCount',
                            Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Sum']
                        }).promise(),
                        cloudwatch.getMetricStatistics({
                            Namespace: 'VZY/OTT', MetricName: 'Invocations',
                            Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                            StartTime: startTime, EndTime: endTime, Period: 300, Statistics: ['Sum']
                        }).promise()
                    ]);
                    
                    const healthValue = healthData.Datapoints.length > 0 ? healthData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0].Average : null;
                    const latencyPoint = latencyData.Datapoints.length > 0 ? latencyData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0] : null;
                    const errorValue = errorData.Datapoints.length > 0 ? errorData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0].Sum : 0;
                    const invocationValue = invocationData.Datapoints.length > 0 ? invocationData.Datapoints.sort((a, b) => b.Timestamp - a.Timestamp)[0].Sum : 0;
                    
                    const avgLatency = latencyPoint ? Math.round(latencyPoint.Average) : 0;
                    const maxLatency = latencyPoint ? Math.round(latencyPoint.Maximum) : 0;
                    const errorRate = invocationValue > 0 ? (errorValue / invocationValue * 100) : 0;
                    
                    let status = 'unknown';
                    if (healthValue !== null) {
                        status = healthValue === 1 ? 'healthy' : healthValue >= 0.5 ? 'warning' : 'down';
                    }
                    
                    results[serviceId] = {
                        name: config.name, status, health: healthValue,
                        avgLatency, maxLatency, errors: errorValue,
                        invocations: invocationValue, errorRate: errorRate.toFixed(2),
                        hasData: healthValue !== null
                    };
                    
                } catch (error) {
                    results[serviceId] = {
                        name: config.name, status: 'unknown', avgLatency: 0, maxLatency: 0,
                        errors: 0, invocations: 0, errorRate: 0, hasData: false
                    };
                }
            }
            return results;
        }

        function openLogs(serviceId) {
            const logGroups = {
                'dish-login-generate-otp': '/aws/lambda/sso-be-proddish-generate-otp',
                'dish-login-validate-otp': '/aws/lambda/sso-be-proddish-validateOtp',
                'monitoring': '/aws/lambda/vzy-ott-monitor'
            };
            const logGroup = logGroups[serviceId] || logGroups['monitoring'];
            const encoded = encodeURIComponent(logGroup).replace(/%2F/g, '$252F');
            window.open(`https://ap-south-1.console.aws.amazon.com/cloudwatch/home?region=ap-south-1#logsV2:log-groups/log-group/${encoded}`, '_blank');
        }

        function showDetails(servicesJson) {
            const services = JSON.parse(servicesJson);
            const gen = services['dish-login-generate-otp'];
            const val = services['dish-login-validate-otp'];
            const totalReq = gen.invocations + val.invocations;
            const totalErr = gen.errors + val.errors;
            const avgLat = Math.round((gen.avgLatency + val.avgLatency) / 2);
            const status = (gen.status === 'healthy' && val.status === 'healthy') ? 'healthy' : 'warning';
            const color = status === 'healthy' ? 'green' : 'orange';
            
            document.getElementById('modalContent').innerHTML = `
                <div class="p-8">
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">Login Service Details</h2>
                            <p class="text-gray-600">Complete authentication workflow monitoring</p>
                        </div>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl">√ó</button>
                    </div>
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Total Requests</div>
                            <div class="text-3xl font-bold text-blue-600">${totalReq}</div>
                            <div class="text-xs text-gray-500">Last 5 minutes</div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Avg Latency</div>
                            <div class="text-3xl font-bold text-purple-600">${avgLat}ms</div>
                        </div>
                        <div class="bg-${totalErr > 0 ? 'red' : 'green'}-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Total Errors</div>
                            <div class="text-3xl font-bold text-${totalErr > 0 ? 'red' : 'green'}-600">${totalErr}</div>
                        </div>
                        <div class="bg-${color}-50 rounded-xl p-4">
                            <div class="text-sm text-gray-600">Health</div>
                            <div class="text-3xl font-bold text-${color}-600">${status === 'healthy' ? '‚úì' : '‚ö†'}</div>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold mb-4">Service Breakdown</h3>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-xl p-6 border-2">
                            <h4 class="font-bold text-lg mb-4">Generate OTP ${gen.status === 'healthy' ? '‚úì' : '‚ö†'}</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span>Requests:</span><span class="font-bold">${gen.invocations}</span></div>
                                <div class="flex justify-between"><span>Avg Latency:</span><span class="font-bold">${gen.avgLatency}ms</span></div>
                                <div class="flex justify-between"><span>Max Latency:</span><span class="font-bold">${gen.maxLatency}ms</span></div>
                                <div class="flex justify-between"><span>Errors:</span><span class="font-bold">${gen.errors}</span></div>
                            </div>
                            <button onclick="openLogs('dish-login-generate-otp')" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">View Logs</button>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-6 border-2">
                            <h4 class="font-bold text-lg mb-4">Validate OTP ${val.status === 'healthy' ? '‚úì' : '‚ö†'}</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span>Requests:</span><span class="font-bold">${val.invocations}</span></div>
                                <div class="flex justify-between"><span>Avg Latency:</span><span class="font-bold">${val.avgLatency}ms</span></div>
                                <div class="flex justify-between"><span>Max Latency:</span><span class="font-bold">${val.maxLatency}ms</span></div>
                                <div class="flex justify-between"><span>Errors:</span><span class="font-bold">${val.errors}</span></div>
                            </div>
                            <button onclick="openLogs('dish-login-validate-otp')" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">View Logs</button>
                        </div>
                    </div>
                    <div class="bg-blue-50 rounded-xl p-6 mb-6">
                        <h4 class="font-bold text-blue-900 mb-3">Configured Thresholds</h4>
                        <div class="grid grid-cols-3 gap-4 text-sm text-blue-800">
                            <div><strong>Latency:</strong> Warning ${THRESHOLDS.latency.warning}ms | Critical ${THRESHOLDS.latency.critical}ms</div>
                            <div><strong>Error Rate:</strong> Warning ${THRESHOLDS.errorRate.warning}% | Critical ${THRESHOLDS.errorRate.critical}%</div>
                            <div><strong>Request Limit:</strong> ${THRESHOLDS.requestLimit.max}/5min (Warning at ${THRESHOLDS.requestLimit.warning})</div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <strong>Current Status:</strong> ${totalReq} requests (${Math.round(totalReq/THRESHOLDS.requestLimit.max*100)}% of limit)
                        </div>
                    </div>
                    <button onclick="closeModal()" class="w-full px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                </div>
            `;
            document.getElementById('serviceModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('serviceModal').classList.add('hidden');
        }

        document.getElementById('serviceModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function render(services) {
            const hasData = Object.values(services).some(s => s.hasData);
            const gen = services['dish-login-generate-otp'];
            const val = services['dish-login-validate-otp'];
            const totalReq = gen.invocations + val.invocations;
            const totalErr = gen.errors + val.errors;
            const avgLat = Math.round((gen.avgLatency + val.avgLatency) / 2);
            const status = (gen.status === 'healthy' && val.status === 'healthy') ? 'healthy' : 'warning';
            const color = status === 'healthy' ? 'green' : 'orange';
            const icon = status === 'healthy' ? '‚úì' : '‚ö†';
            const reqUsage = Math.round(totalReq / THRESHOLDS.requestLimit.max * 100);
            const isLatWarn = avgLat > THRESHOLDS.latency.warning;
            const isReqWarn = totalReq > THRESHOLDS.requestLimit.warning;
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h1 class="text-3xl font-bold">üì∫ VZY OTT Platform Monitor</h1>
                                <p class="text-gray-500 mt-1">Real-time system health ‚Ä¢ Region: ap-south-1</p>
                                ${hasData ? '<p class="text-green-600 text-sm mt-2 font-semibold">‚úì Connected to AWS CloudWatch - REAL data</p>' : '<p class="text-yellow-600 text-sm mt-2">‚ö† No metrics</p>'}
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500 mb-2">Last updated: ${new Date().toLocaleTimeString()}</div>
                                <div class="flex gap-2">
                                    <button onclick="openLogs('monitoring')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">üìä Monitoring Logs</button>
                                    <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">üîÑ Refresh</button>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4"><div class="text-2xl font-bold">2</div><div class="text-sm text-gray-600">Services</div></div>
                            <div class="bg-${color}-50 rounded-lg p-4"><div class="text-2xl font-bold text-${color}-600">${status==='healthy'?'2':'1'}</div><div class="text-sm text-gray-600">Healthy</div></div>
                            <div class="bg-blue-50 rounded-lg p-4"><div class="text-2xl font-bold text-blue-600">${totalReq}</div><div class="text-sm text-gray-600">Requests (5min)</div></div>
                            <div class="bg-${totalErr>0?'red':'green'}-50 rounded-lg p-4"><div class="text-2xl font-bold text-${totalErr>0?'red':'green'}-600">${totalErr}</div><div class="text-sm text-gray-600">Errors</div></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Dish Backend - Login Services</h2>
                        <div onclick='showDetails(${JSON.stringify(services).replace(/'/g, "\\'")})'  class="bg-${color}-50 border-2 border-${color}-200 rounded-xl p-6 hover:shadow-xl transition cursor-pointer">
                            <div class="flex items-center justify-between mb-4">
                                <div><h3 class="text-2xl font-bold">Login Service</h3><p class="text-sm text-gray-600">OTP Generation & Validation</p></div>
                                <div class="text-5xl text-${color}-600">${icon}</div>
                            </div>
                            <div class="grid grid-cols-4 gap-4 mb-4">
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="text-xs text-gray-600">Avg Latency</div>
                                    <div class="text-2xl font-bold ${isLatWarn?'text-orange-600':'text-'+color+'-700'}">${avgLat}ms</div>
                                    ${isLatWarn?'<div class="text-xs text-orange-600">‚ö† Above threshold</div>':''}
                                </div>
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="text-xs text-gray-600">Total Requests</div>
                                    <div class="text-2xl font-bold ${isReqWarn?'text-orange-600':'text-blue-700'}">${totalReq}</div>
                                    <div class="text-xs text-gray-600">${reqUsage}% of limit</div>
                                </div>
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="text-xs text-gray-600">Error Count</div>
                                    <div class="text-2xl font-bold ${totalErr>0?'text-red-600':'text-green-700'}">${totalErr}</div>
                                    <div class="text-xs text-gray-600">0% error rate</div>
                                </div>
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="text-xs text-gray-600">Health Score</div>
                                    <div class="text-2xl font-bold text-${color}-700">${gen.health!==null?gen.health.toFixed(1):'N/A'}</div>
                                    <div class="text-xs text-gray-600">${status}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="font-semibold text-sm mb-2">Generate OTP ${gen.status==='healthy'?'‚úì':'‚ö†'}</div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div class="flex justify-between"><span>Latency:</span><span class="font-mono font-semibold">${gen.avgLatency}ms</span></div>
                                        <div class="flex justify-between"><span>Requests:</span><span class="font-mono font-semibold">${gen.invocations}</span></div>
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-3 border">
                                    <div class="font-semibold text-sm mb-2">Validate OTP ${val.status==='healthy'?'‚úì':'‚ö†'}</div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div class="flex justify-between"><span>Latency:</span><span class="font-mono font-semibold">${val.avgLatency}ms</span></div>
                                        <div class="flex justify-between"><span>Requests:</span><span class="font-mono font-semibold">${val.invocations}</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-3 border">
                                <div class="text-xs font-semibold text-gray-700 mb-2">Threshold Status:</div>
                                <div class="flex gap-4 text-xs">
                                    <div class="flex items-center gap-1"><span class="${avgLat<THRESHOLDS.latency.warning?'text-green-600':'text-orange-600'}">‚óè</span><span>Latency: ${avgLat}/${THRESHOLDS.latency.warning}ms</span></div>
                                    <div class="flex items-center gap-1"><span class="${totalReq<THRESHOLDS.requestLimit.warning?'text-green-600':'text-orange-600'}">‚óè</span><span>Requests: ${totalReq}/${THRESHOLDS.requestLimit.max}</span></div>
                                    <div class="flex items-center gap-1"><span class="${totalErr===0?'text-green-600':'text-red-600'}">‚óè</span><span>Errors: ${totalErr}</span></div>
                                </div>
                            </div>
                            <div class="mt-4 pt-3 border-t text-${color}-700 text-sm font-semibold text-center">Click for detailed breakdown and CloudWatch logs ‚Üí</div>
                        </div>
                    </div>
                    <div class="bg-blue-50 border rounded-xl p-6">
                        <h3 class="font-semibold text-blue-900 mb-2">üí° Monitoring Configuration</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm text-blue-800">
                            <div><p class="font-semibold mb-1">Thresholds:</p><ul class="space-y-1 text-xs"><li>‚Ä¢ Latency Warning: ${THRESHOLDS.latency.warning}ms</li><li>‚Ä¢ Latency Critical: ${THRESHOLDS.latency.critical}ms</li><li>‚Ä¢ Error Rate Warning: ${THRESHOLDS.errorRate.warning}%</li><li>‚Ä¢ Request Limit: ${THRESHOLDS.requestLimit.max}/5min</li></ul></div>
                            <div><p class="font-semibold mb-1">Status:</p><ul class="space-y-1 text-xs"><li>‚úì CloudWatch: VZY/OTT</li><li>‚úì Frequency: Every 5 min</li><li>‚úì Email: watcho1tech@dishd2h.com</li><li>‚úì Real-time active</li></ul></div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function init() {
            try {
                updateStatus('Testing connection...');
                await cloudwatch.listMetrics({ Namespace: 'VZY/OTT' }).promise();
                console.log('‚úì Connected');
                const services = await fetchMetrics();
                render(services);
                console.log('‚úì Loaded');
            } catch (error) {
                console.error(error);
                document.getElementById('app').innerHTML = `<div class="max-w-2xl mx-auto mt-12 bg-red-50 border rounded-xl p-8"><h2 class="text-2xl font-bold text-red-900 mb-4">‚ö† Error</h2><p class="text-red-800 mb-4">${error.message}</p><button onclick="location.reload()" class="px-6 py-3 bg-red-600 text-white rounded-lg">Retry</button></div>`;
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>

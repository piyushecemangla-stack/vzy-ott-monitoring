<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VZY OTT Platform Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Sora:wght@300;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1563.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Sora', -apple-system, system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        
        .stat-number { font-family: 'JetBrains Mono', monospace; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .block-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .block-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            opacity: 0.8;
        }

        .block-dish::before { background: linear-gradient(180deg, #3b82f6, #06b6d4); }
        .block-partners::before { background: linear-gradient(180deg, #a855f7, #ec4899); }
        
        .service-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .service-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .service-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .service-card:hover::after { opacity: 1; }

        .partner-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 1rem;
            filter: brightness(0.9);
            transition: filter 0.3s;
        }

        .service-card:hover .partner-logo {
            filter: brightness(1.1);
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-healthy { background: #10b981; box-shadow: 0 0 12px #10b981; }
        .status-warning { background: #f59e0b; box-shadow: 0 0 12px #f59e0b; }
        .status-down { background: #ef4444; box-shadow: 0 0 12px #ef4444; }
        
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in { animation: slideIn 0.6s ease-out; }
        
        .log-entry {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .log-entry.threshold-exceeded {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .log-entry.error {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
        }

        .log-timestamp {
            color: #94a3b8;
            font-size: 0.75rem;
            margin-bottom: 8px;
        }

        .log-metric {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 8px;
            margin-right: 8px;
            font-weight: 600;
        }

        .metric-normal { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .metric-warning { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .metric-critical { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .refresh-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Refresh Indicator -->
    <div id="refreshIndicator" class="refresh-indicator">
        üîÑ Auto-refreshing...
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card max-w-6xl w-full max-h-[90vh] overflow-y-auto p-8">
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="min-h-screen p-6">
        <div class="max-w-[1600px] mx-auto">
            <!-- Header -->
            <div class="glass-card p-8 mb-8 slide-in">
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h1 class="text-5xl font-800 mb-2 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                            VZY OTT Monitor
                        </h1>
                        <p class="text-slate-400 text-lg">Real-time performance analytics ¬∑ Region ap-south-1</p>
                        <div class="flex items-center gap-4 mt-3">
                            <div class="flex items-center gap-2">
                                <div class="status-dot status-healthy pulse"></div>
                                <span class="text-emerald-400 text-sm font-600">Live</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="status-dot status-healthy"></div>
                                <span class="text-slate-400 text-sm">Auto-refresh: 2 min</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="stat-number text-slate-400 text-sm mb-2">Last updated</div>
                        <div class="stat-number text-2xl font-700" id="lastUpdate">--:--:--</div>
                        <div class="stat-number text-slate-500 text-xs mt-1">Next refresh: <span id="nextRefresh">--</span>s</div>
                    </div>
                </div>

                <!-- Date Range Controls -->
                <div class="grid grid-cols-5 gap-4 mt-6">
                    <div>
                        <label class="text-slate-400 text-sm mb-2 block">Start Date</label>
                        <input type="date" id="startDate" class="glass-card px-4 py-2 w-full rounded-lg text-white">
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm mb-2 block">End Date</label>
                        <input type="date" id="endDate" class="glass-card px-4 py-2 w-full rounded-lg text-white">
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm mb-2 block">Quick Select</label>
                        <select id="quickSelect" class="glass-card px-4 py-2 w-full rounded-lg text-white" onchange="applyQuickSelect()">
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="14d">Last 14 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadData()" class="glass-card px-6 py-2 w-full rounded-lg text-white font-600 hover:bg-blue-500 transition">
                            üîÑ Refresh Now
                        </button>
                    </div>
                    <div class="flex items-end">
                        <button onclick="exportCSV()" class="glass-card px-6 py-2 w-full rounded-lg text-white font-600 hover:bg-green-500 transition">
                            üì• Export CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="grid grid-cols-4 gap-6 mb-8">
                <div class="glass-card p-6 slide-in" style="animation-delay: 0.1s">
                    <div class="text-slate-400 text-sm mb-2">Total Requests</div>
                    <div class="stat-number text-4xl font-700" id="totalRequests">--</div>
                    <div class="text-slate-500 text-xs mt-2 stat-number" id="dateRange">Loading...</div>
                </div>
                <div class="glass-card p-6 slide-in" style="animation-delay: 0.2s">
                    <div class="text-slate-400 text-sm mb-2">Avg Latency</div>
                    <div class="stat-number text-4xl font-700 text-emerald-400" id="avgLatency">--ms</div>
                    <div class="text-slate-500 text-xs mt-2">Target: &lt;500ms</div>
                </div>
                <div class="glass-card p-6 slide-in" style="animation-delay: 0.3s">
                    <div class="text-slate-400 text-sm mb-2">Total Errors</div>
                    <div class="stat-number text-4xl font-700 text-red-400" id="totalErrors">--</div>
                    <div class="stat-number text-slate-500 text-xs mt-2">Rate: <span id="errorRate">--%</span></div>
                </div>
                <div class="glass-card p-6 slide-in" style="animation-delay: 0.4s">
                    <div class="text-slate-400 text-sm mb-2">System Health</div>
                    <div class="text-4xl font-700">
                        <span id="healthyCount" class="text-emerald-400">--</span>
                        <span class="text-slate-600 text-2xl">/</span>
                        <span id="totalServices" class="text-slate-400">7</span>
                    </div>
                    <div class="text-slate-500 text-xs mt-2">Services Operational</div>
                </div>
            </div>

            <!-- Services Container -->
            <div id="servicesContainer"></div>
        </div>
    </div>

    <script>
        AWS.config.update({
            accessKeyId: 'AKIAWT5V2FQ6MKAHDFZB',
            secretAccessKey: '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',
            region: 'ap-south-1'
        });

        const logs = new AWS.CloudWatchLogs();
        
        const SERVICES = {
            'generate-otp': { name: 'Generate OTP', logGroup: '/aws/lambda/sso-be-proddish-generate-otp', category: 'Dish Backend', threshold: 500, icon: 'üîë' },
            'validateOtp': { name: 'Validate OTP', logGroup: '/aws/lambda/sso-be-proddish-validateOtp', category: 'Dish Backend', threshold: 500, icon: '‚úì' },
            'getUserInfo': { name: 'Get User Info', logGroup: '/aws/lambda/sso-be-proddish-getUserInfo', category: 'Dish Backend', threshold: 500, icon: 'üë§' },
            'zee5': { name: 'Zee5', logGroup: '/aws/lambda/sso-be-proddish-zee5', category: 'Content Partners', threshold: 2000, logo: 'https://upload.wikimedia.org/wikipedia/commons/1/17/ZEE5_logo.jpg' },
            'sunNext': { name: 'Sun NXT', logGroup: '/aws/lambda/sso-be-proddish-sunNext', category: 'Content Partners', threshold: 2000, logo: 'https://sunnxt.com/assets/img/logo.png' },
            'sonyLiv': { name: 'Sony LIV', logGroup: '/aws/lambda/sso-be-proddish-sonyLiv', category: 'Content Partners', threshold: 2000, logo: 'https://www.sonyliv.com/images/sonyliv_logo.png' },
            'jiohotstar': { name: 'JioCinema', logGroup: '/aws/lambda/sso-be-proddish-jiohotstar', category: 'Content Partners', threshold: 2000, logo: 'https://www.jiocinema.com/images/jc_logo_v2.svg' }
        };

        let currentData = null;
        let autoRefreshTimer = null;
        let countdownTimer = null;
        let secondsUntilRefresh = 120;

        function applyQuickSelect() {
            const value = document.getElementById('quickSelect').value;
            const end = new Date();
            let start = new Date();

            switch(value) {
                case '24h': start.setHours(start.getHours() - 24); break;
                case '7d': start.setDate(start.getDate() - 7); break;
                case '14d': start.setDate(start.getDate() - 14); break;
                case '30d': start.setDate(start.getDate() - 30); break;
            }

            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        async function loadData() {
            showRefreshIndicator();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            try {
                const data = await fetchData(start, end);
                currentData = data;
                renderDashboard(data, start, end);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                resetAutoRefresh();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function resetAutoRefresh() {
            // Clear existing timers
            if (autoRefreshTimer) clearTimeout(autoRefreshTimer);
            if (countdownTimer) clearInterval(countdownTimer);
            
            // Set refresh for 2 minutes
            secondsUntilRefresh = 120;
            autoRefreshTimer = setTimeout(() => loadData(), 120000);
            
            // Update countdown
            countdownTimer = setInterval(() => {
                secondsUntilRefresh--;
                document.getElementById('nextRefresh').textContent = secondsUntilRefresh;
                if (secondsUntilRefresh <= 0) clearInterval(countdownTimer);
            }, 1000);
        }

        async function fetchData(startDate, endDate) {
            const start = new Date(startDate).getTime();
            const end = new Date(endDate + 'T23:59:59').getTime();
            const results = {};

            for (const [id, config] of Object.entries(SERVICES)) {
                try {
                    const events = await logs.filterLogEvents({
                        logGroupName: config.logGroup,
                        startTime: start,
                        endTime: end,
                        filterPattern: 'REPORT'
                    }).promise();

                    const reports = events.events || [];
                    let invocations = 0, totalDuration = 0, latencies = [], timestamps = [];

                    reports.forEach(event => {
                        invocations++;
                        const match = event.message.match(/Duration: ([\d.]+) ms/);
                        if (match) {
                            const latency = parseFloat(match[1]);
                            totalDuration += latency;
                            latencies.push(latency);
                            timestamps.push({ time: event.timestamp, latency });
                        }
                    });

                    const thresholdViolations = timestamps.filter(t => t.latency > config.threshold);

                    results[id] = {
                        name: config.name,
                        category: config.category,
                        threshold: config.threshold,
                        logo: config.logo,
                        icon: config.icon,
                        logGroup: config.logGroup,
                        invocations,
                        avgLatency: invocations > 0 ? Math.round(totalDuration / invocations) : 0,
                        minLatency: latencies.length > 0 ? Math.round(Math.min(...latencies)) : 0,
                        maxLatency: latencies.length > 0 ? Math.round(Math.max(...latencies)) : 0,
                        errors: 0,
                        violations: thresholdViolations
                    };
                } catch (error) {
                    results[id] = { name: config.name, category: config.category, threshold: config.threshold, logo: config.logo, icon: config.icon, logGroup: config.logGroup, invocations: 0, avgLatency: 0, minLatency: 0, maxLatency: 0, errors: 0, violations: [] };
                }
            }

            return results;
        }

        function renderDashboard(data, start, end) {
            // Summary
            let totalReq = 0, totalLat = 0, totalErr = 0, count = 0, healthy = 0;
            Object.values(data).forEach(s => {
                totalReq += s.invocations;
                if (s.invocations > 0) { totalLat += s.avgLatency; count++; }
                totalErr += s.errors;
                if (s.avgLatency < s.threshold && s.errors === 0) healthy++;
            });

            document.getElementById('totalRequests').textContent = totalReq.toLocaleString();
            document.getElementById('avgLatency').textContent = count > 0 ? Math.round(totalLat / count) + 'ms' : '--ms';
            document.getElementById('totalErrors').textContent = totalErr;
            document.getElementById('errorRate').textContent = totalReq > 0 ? ((totalErr / totalReq) * 100).toFixed(2) + '%' : '--%';
            document.getElementById('healthyCount').textContent = healthy;
            document.getElementById('dateRange').textContent = `${start} to ${end}`;

            // Services by category
            const backend = Object.entries(data).filter(([,s]) => s.category === 'Dish Backend');
            const partners = Object.entries(data).filter(([,s]) => s.category === 'Content Partners');

            const backendHealthy = backend.filter(([,s]) => s.avgLatency < s.threshold && s.errors === 0).length;
            const partnersHealthy = partners.filter(([,s]) => s.avgLatency < s.threshold && s.errors === 0).length;
            const backendTotal = backend.reduce((sum, [,s]) => sum + s.invocations, 0);
            const partnersTotal = partners.reduce((sum, [,s]) => sum + s.invocations, 0);

            document.getElementById('servicesContainer').innerHTML = `
                <div class="block-card block-dish mb-8 slide-in">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div class="text-6xl">üîê</div>
                            <div>
                                <h2 class="text-4xl font-800 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent mb-2">
                                    Dish Backend
                                </h2>
                                <p class="text-slate-400">Core authentication & user services</p>
                            </div>
                        </div>
                        <div class="glass-card p-6 text-right">
                            <div class="flex items-center gap-3 justify-end mb-3">
                                <div class="status-dot status-${backendHealthy === backend.length ? 'healthy' : 'warning'} pulse"></div>
                                <span class="stat-number font-700 text-3xl">${backendHealthy}/${backend.length}</span>
                            </div>
                            <div class="stat-number text-emerald-400 font-600">${backendTotal.toLocaleString()} Requests</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-6">
                        ${backend.map(([id, s]) => renderCard(id, s)).join('')}
                    </div>
                </div>

                <div class="block-card block-partners slide-in">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div class="text-6xl">üé¨</div>
                            <div>
                                <h2 class="text-4xl font-800 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent mb-2">
                                    Content Partners
                                </h2>
                                <p class="text-slate-400">OTT platform integrations</p>
                            </div>
                        </div>
                        <div class="glass-card p-6 text-right">
                            <div class="flex items-center gap-3 justify-end mb-3">
                                <div class="status-dot status-${partnersHealthy === partners.length ? 'healthy' : 'warning'} pulse"></div>
                                <span class="stat-number font-700 text-3xl">${partnersHealthy}/${partners.length}</span>
                            </div>
                            <div class="stat-number text-purple-400 font-600">${partnersTotal.toLocaleString()} Requests</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-6">
                        ${partners.map(([id, s]) => renderCard(id, s)).join('')}
                    </div>
                </div>
            `;
        }

        function renderCard(id, s) {
            const status = s.avgLatency > s.threshold || s.errors > 0 ? 'warning' : s.invocations > 0 ? 'healthy' : 'unknown';
            const statusColor = status === 'healthy' ? 'emerald' : status === 'warning' ? 'amber' : 'slate';
            
            const logoOrIcon = s.logo ? 
                `<img src="${s.logo}" class="partner-logo" alt="${s.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                 <div style="display:none; font-size: 4rem; margin-bottom: 1rem;">${s.icon || 'üé¨'}</div>` : 
                `<div style="font-size: 4rem; margin-bottom: 1rem;">${s.icon}</div>`;
            
            return `
                <div class="service-card p-6 cursor-pointer" onclick="showModal('${id}')">
                    <div class="flex flex-col items-center text-center mb-4">
                        ${logoOrIcon}
                        <h3 class="text-lg font-700 mb-2">${s.name}</h3>
                        <div class="flex items-center gap-2">
                            <div class="status-dot status-${status}"></div>
                            <span class="text-${statusColor}-400 text-sm font-600 uppercase tracking-wide">${status}</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                        <div class="bg-emerald-500 bg-opacity-10 rounded-lg p-3 border border-emerald-500 border-opacity-20">
                            <div class="text-emerald-400 text-xs mb-1 font-600">MIN</div>
                            <div class="stat-number font-700 text-lg">${s.minLatency}ms</div>
                        </div>
                        <div class="bg-blue-500 bg-opacity-10 rounded-lg p-3 border border-blue-500 border-opacity-20">
                            <div class="text-blue-400 text-xs mb-1 font-600">AVG</div>
                            <div class="stat-number font-700 text-lg text-blue-400">${s.avgLatency}ms</div>
                        </div>
                        <div class="bg-red-500 bg-opacity-10 rounded-lg p-3 border border-red-500 border-opacity-20">
                            <div class="text-red-400 text-xs mb-1 font-600">MAX</div>
                            <div class="stat-number font-700 text-lg">${s.maxLatency}ms</div>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between text-slate-400">
                            <span>Requests:</span>
                            <span class="stat-number font-700 text-white">${s.invocations.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-slate-400">
                            <span>Violations:</span>
                            <span class="stat-number font-700 text-${s.violations.length > 0 ? 'red' : 'emerald'}-400">${s.violations.length}</span>
                        </div>
                        <div class="flex justify-between text-slate-400">
                            <span>Threshold:</span>
                            <span class="stat-number font-700 text-slate-300">${s.threshold}ms</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-700 text-center text-sm text-blue-400 font-600 hover:text-blue-300 transition">
                        View Logs & Timeline ‚Üí
                    </div>
                </div>
            `;
        }

        async function showModal(id) {
            const s = currentData[id];
            
            // Fetch recent logs
            let logsHtml = '<div class="text-center text-slate-400 p-4">Loading logs...</div>';
            
            document.getElementById('modalContent').innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-3xl font-800 mb-2">${s.name}</h2>
                        <p class="text-slate-400">${s.category} ¬∑ Threshold: ${s.threshold}ms</p>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-white text-4xl leading-none">&times;</button>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-800 rounded-xl p-6 text-center">
                        <div class="text-slate-400 text-sm mb-2">Total Requests</div>
                        <div class="stat-number text-4xl font-700">${s.invocations.toLocaleString()}</div>
                    </div>
                    <div class="bg-slate-800 rounded-xl p-6 text-center">
                        <div class="text-slate-400 text-sm mb-2">Average Latency</div>
                        <div class="stat-number text-4xl font-700 text-blue-400">${s.avgLatency}ms</div>
                    </div>
                    <div class="bg-slate-800 rounded-xl p-6 text-center">
                        <div class="text-slate-400 text-sm mb-2">Threshold Violations</div>
                        <div class="stat-number text-4xl font-700 text-${s.violations.length > 0 ? 'red' : 'emerald'}-400">${s.violations.length}</div>
                    </div>
                </div>

                ${s.violations.length > 0 ? `
                <div class="bg-red-900 bg-opacity-20 border border-red-500 border-opacity-30 rounded-xl p-6 mb-6">
                    <h3 class="font-700 text-xl mb-4 text-red-400">‚ö†Ô∏è Threshold Violations Detected</h3>
                    <div class="space-y-2">
                        ${s.violations.slice(0, 5).map(v => `
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-300">${new Date(v.time).toLocaleString()}</span>
                                <span class="stat-number font-700 text-red-400">${Math.round(v.latency)}ms (>${s.threshold}ms)</span>
                            </div>
                        `).join('')}
                        ${s.violations.length > 5 ? `<div class="text-slate-400 text-sm">... and ${s.violations.length - 5} more</div>` : ''}
                    </div>
                </div>
                ` : ''}

                <div class="bg-slate-800 rounded-xl p-6 mb-6">
                    <h3 class="font-700 text-xl mb-4">üìä Performance Timeline</h3>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-emerald-400 text-sm mb-2">Best Performance</div>
                            <div class="stat-number text-3xl font-700">${s.minLatency}ms</div>
                        </div>
                        <div>
                            <div class="text-blue-400 text-sm mb-2">Average</div>
                            <div class="stat-number text-3xl font-700">${s.avgLatency}ms</div>
                        </div>
                        <div>
                            <div class="text-red-400 text-sm mb-2">Peak Latency</div>
                            <div class="stat-number text-3xl font-700">${s.maxLatency}ms</div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl p-6">
                    <h3 class="font-700 text-xl mb-4">üìã Recent CloudWatch Logs</h3>
                    <div id="logsContainer" class="max-h-96 overflow-y-auto">
                        ${logsHtml}
                    </div>
                </div>
            `;
            
            document.getElementById('modal').classList.remove('hidden');
            
            // Fetch and render logs
            const actualLogs = await fetchLogs(s.logGroup, s.threshold);
            document.getElementById('logsContainer').innerHTML = actualLogs;
        }

        async function fetchLogs(logGroup, threshold) {
            try {
                const streams = await logs.describeLogStreams({
                    logGroupName: logGroup,
                    orderBy: 'LastEventTime',
                    descending: true,
                    limit: 3
                }).promise();

                if (!streams.logStreams || streams.logStreams.length === 0) {
                    return '<div class="text-slate-400 text-center p-4">No recent logs found</div>';
                }

                let allLogs = [];
                for (const stream of streams.logStreams.slice(0, 2)) {
                    try {
                        const events = await logs.getLogEvents({
                            logGroupName: logGroup,
                            logStreamName: stream.logStreamName,
                            limit: 20,
                            startFromHead: false
                        }).promise();
                        allLogs = allLogs.concat(events.events || []);
                    } catch (e) {}
                }

                allLogs.sort((a, b) => b.timestamp - a.timestamp);
                allLogs = allLogs.slice(0, 15);

                if (allLogs.length === 0) {
                    return '<div class="text-slate-400 text-center p-4">No log events found</div>';
                }

                let html = '';
                allLogs.forEach(event => {
                    const msg = event.message;
                    const time = new Date(event.timestamp);
                    
                    if (msg.includes('REPORT')) {
                        const durationMatch = msg.match(/Duration: ([\d.]+) ms/);
                        const billedMatch = msg.match(/Billed Duration: ([\d.]+) ms/);
                        const memoryMatch = msg.match(/Memory Size: ([\d.]+) MB/);
                        const usedMemMatch = msg.match(/Max Memory Used: ([\d.]+) MB/);
                        
                        if (durationMatch) {
                            const duration = parseFloat(durationMatch[1]);
                            const exceeded = duration > threshold;
                            const metricClass = exceeded ? 'metric-critical' : duration > threshold * 0.8 ? 'metric-warning' : 'metric-normal';
                            
                            html += `
                                <div class="log-entry ${exceeded ? 'threshold-exceeded' : ''}">
                                    <div class="log-timestamp">${time.toLocaleString()}</div>
                                    <div class="mb-2">
                                        <span class="log-metric ${metricClass}">‚è±Ô∏è ${duration.toFixed(0)}ms</span>
                                        ${billedMatch ? `<span class="log-metric metric-normal">üí≥ ${billedMatch[1]}ms billed</span>` : ''}
                                    </div>
                                    <div>
                                        ${memoryMatch && usedMemMatch ? `<span class="log-metric metric-normal">üíæ ${usedMemMatch[1]}MB / ${memoryMatch[1]}MB</span>` : ''}
                                    </div>
                                    ${exceeded ? '<div class="text-red-400 text-xs mt-2">‚ö†Ô∏è Exceeded threshold of ' + threshold + 'ms</div>' : ''}
                                </div>
                            `;
                        }
                    } else if (msg.includes('ERROR')) {
                        html += `
                            <div class="log-entry error">
                                <div class="log-timestamp">${time.toLocaleString()}</div>
                                <div class="text-red-400 font-600">‚ùå ERROR</div>
                                <div class="text-slate-300 text-xs mt-2">${msg.substring(0, 150)}...</div>
                            </div>
                        `;
                    }
                });

                return html || '<div class="text-slate-400 text-center p-4">No detailed logs available</div>';
            } catch (error) {
                return `<div class="text-red-400 p-4">Error loading logs: ${error.message}</div>`;
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function exportCSV() {
            if (!currentData) return;
            let csv = 'Service,Category,Requests,Avg Latency,Min Latency,Max Latency,Errors,Violations,Threshold\n';
            Object.values(currentData).forEach(s => {
                csv += `${s.name},${s.category},${s.invocations},${s.avgLatency},${s.minLatency},${s.maxLatency},${s.errors},${s.violations.length},${s.threshold}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vzy-monitoring-${document.getElementById('startDate').value}-to-${document.getElementById('endDate').value}.csv`;
            a.click();
        }

        window.addEventListener('load', () => {
            applyQuickSelect();
            setTimeout(() => loadData(), 300);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshTimer) clearTimeout(autoRefreshTimer);
            if (countdownTimer) clearInterval(countdownTimer);
        });
    </script>
</body>
</html>

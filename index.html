<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VZY OTT Platform Monitor</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1563.0.min.js"></script>
</head>

<body class="bg-gray-50">
<div id="app" class="min-h-screen p-6">
<div class="max-w-7xl mx-auto">
<div class="text-center py-12">
<div class="inline-block w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
<p class="text-gray-600 text-lg">Connecting to CloudWatch...</p>
<p class="text-gray-400 text-sm mt-2" id="status">Initializing...</p>
</div>
</div>
</div>

<script>
console.log('Dashboard starting...');

/* ================= AWS CONFIG ================= */
/* ‚ö†Ô∏è ROTATE THESE KEYS AFTER TESTING */
AWS.config.update({
    accessKeyId: 'AKIAWT5V2FQ6MKAHDFZB',
    secretAccessKey: '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',
    region: 'ap-south-1'
});

const cloudwatch = new AWS.CloudWatch();

function updateStatus(msg) {
    document.getElementById('status').textContent = msg;
}

/* ================= FETCH METRICS ================= */
async function fetchMetrics() {
    updateStatus('Fetching metrics from CloudWatch...');

    const services = {
        'dish-login-generate-otp': { name: 'Generate OTP' },
        'dish-login-validate-otp': { name: 'Validate OTP' }
    };

    const endTime = new Date();
    const startTime = new Date(endTime.getTime() - 30 * 60 * 1000);

    const results = {};

    for (const [serviceId, config] of Object.entries(services)) {
        try {

            // Health
            const healthData = await cloudwatch.getMetricStatistics({
                Namespace: 'VZY/OTT',
                MetricName: 'ServiceHealth',
                Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                StartTime: startTime,
                EndTime: endTime,
                Period: 300,
                Statistics: ['Average']
            }).promise();

            // Latency
            const latencyData = await cloudwatch.getMetricStatistics({
                Namespace: 'VZY/OTT',
                MetricName: 'ServiceLatency',
                Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                StartTime: startTime,
                EndTime: endTime,
                Period: 300,
                Statistics: ['Average']
            }).promise();

            // Errors
            const errorData = await cloudwatch.getMetricStatistics({
                Namespace: 'VZY/OTT',
                MetricName: 'ErrorCount',
                Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                StartTime: startTime,
                EndTime: endTime,
                Period: 300,
                Statistics: ['Sum']
            }).promise();

            // ‚≠ê NEW ‚Äî Requests
            const requestData = await cloudwatch.getMetricStatistics({
                Namespace: 'VZY/OTT',
                MetricName: 'RequestCount',
                Dimensions: [{ Name: 'ServiceName', Value: serviceId }],
                StartTime: startTime,
                EndTime: endTime,
                Period: 300,
                Statistics: ['Sum']
            }).promise();

            const latest = (arr, key) =>
                arr.Datapoints.length
                    ? arr.Datapoints.sort((a,b)=>b.Timestamp-a.Timestamp)[0][key]
                    : 0;

            const healthValue = latest(healthData, 'Average');
            const latencyValue = latest(latencyData, 'Average');
            const errorValue = latest(errorData, 'Sum');
            const requestValue = latest(requestData, 'Sum');

            let status = 'unknown';
            if (healthValue === 1) status = 'healthy';
            else if (healthValue >= 0.5) status = 'warning';
            else status = 'down';

            results[serviceId] = {
                name: config.name,
                status,
                health: healthValue,
                latency: Math.round(latencyValue),
                errors: errorValue,
                requests: requestValue,
                hasData: healthValue !== null
            };

        } catch (e) {
            console.error(e);
        }
    }

    return results;
}

/* ================= LOG LINK ================= */
function openLogs(serviceId) {
    const logGroups = {
        'dish-login-generate-otp': '/aws/lambda/sso-be-proddish-generate-otp',
        'dish-login-validate-otp': '/aws/lambda/sso-be-proddish-validateOtp'
    };

    const encoded = encodeURIComponent(logGroups[serviceId]).replace(/%2F/g,'$252F');
    window.open(
        `https://ap-south-1.console.aws.amazon.com/cloudwatch/home?region=ap-south-1#logsV2:log-groups/log-group/${encoded}`,
        '_blank'
    );
}

/* ================= RENDER ================= */
function render(services) {

    const now = new Date().toLocaleTimeString();

    document.getElementById('app').innerHTML = `
    <div class="max-w-7xl mx-auto">

        <!-- HEADER -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h1 class="text-3xl font-bold">üì∫ VZY OTT Platform Monitor</h1>
            <div class="text-sm text-gray-500 mt-2">Last updated: ${now}</div>
        </div>

        <!-- LOGIN SERVICE -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">üîê Login Service</h2>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 border-b">
                            <th class="p-3 text-left">Metric</th>
                            <th class="p-3 text-center">Generate OTP</th>
                            <th class="p-3 text-center">Validate OTP</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr class="border-b">
                            <td class="p-3 font-medium">Requests</td>
                            <td class="p-3 text-center font-mono">
                                ${services['dish-login-generate-otp']?.requests || 0}
                            </td>
                            <td class="p-3 text-center font-mono">
                                ${services['dish-login-validate-otp']?.requests || 0}
                            </td>
                        </tr>

                        <tr class="border-b">
                            <td class="p-3 font-medium">Latency</td>
                            <td class="p-3 text-center font-mono">
                                ${services['dish-login-generate-otp']?.latency || 0} ms
                            </td>
                            <td class="p-3 text-center font-mono">
                                ${services['dish-login-validate-otp']?.latency || 0} ms
                            </td>
                        </tr>

                        <tr class="border-b">
                            <td class="p-3 font-medium">Health</td>
                            <td class="p-3 text-center font-mono">
                                ${services['dish-login-generate-otp']?.health?.toFixed(1) || 'N/A'}
                            </td>
                            <td class="p-3 text-center font-mono">
                                ${services['dish-login-validate-otp']?.health?.toFixed(1) || 'N/A'}
                            </td>
                        </tr>

                        <tr>
                            <td class="p-3 font-medium">Errors</td>
                            <td class="p-3 text-center font-mono text-red-600">
                                ${services['dish-login-generate-otp']?.errors || 0}
                            </td>
                            <td class="p-3 text-center font-mono text-red-600">
                                ${services['dish-login-validate-otp']?.errors || 0}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 flex gap-3">
                <button onclick="openLogs('dish-login-generate-otp')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">
                    Generate OTP Logs
                </button>

                <button onclick="openLogs('dish-login-validate-otp')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm">
                    Validate OTP Logs
                </button>
            </div>
        </div>

    </div>
    `;
}

/* ================= INIT ================= */
async function init() {
    try {
        updateStatus('Testing AWS connection...');
        await cloudwatch.listMetrics({ Namespace:'VZY/OTT' }).promise();

        const services = await fetchMetrics();
        render(services);

    } catch (e) {
        document.getElementById('app').innerHTML =
            '<div class="text-red-600 text-center mt-10">Connection Error: '+e.message+'</div>';
    }
}

window.addEventListener('load', init);
</script>
</body>
</html>
